---
- name: install libvirt
  include_tasks: '{{ ansible_distribution }}.yml'

- name: Add user to group
  ansible.builtin.user:
    name: "{{ ansible_user_id }}"
    shell: /bin/bash
    groups: libvirt
    append: true
  become: true

- name: ensure hooks directory
  ansible.builtin.file:
    path: /etc/libvirt/hooks/
    state: directory
    mode: '0755'
  become: true

- name: install network hooks
  ansible.builtin.copy:
    src: etc/libvirt/hooks/network
    dest: /etc/libvirt/hooks/network
    mode: '0755'
    owner: root
    group: root
  become: true

- set_fact:
    should_start: "{{ start | default(true) }}"

- name: enable libvirt unit
  ansible.builtin.systemd:
    state: started
    name: "{{ item }}"
    enabled: true
  loop:
    - libvirtd.service
    - libvirtd.socket
    - libvirtd-ro.socket
    - libvirtd-admin.socket
  become: true
  when: should_start
